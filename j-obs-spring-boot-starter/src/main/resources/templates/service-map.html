<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Map - J-Obs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        .service-node {
            transition: all 0.2s ease;
        }
        .service-node:hover {
            transform: scale(1.05);
        }
        .connection-line {
            stroke-linecap: round;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen">
    <div x-data="serviceMapApp()" x-init="init()" class="min-h-screen">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <a th:href="@{/j-obs}" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                            </svg>
                        </a>
                        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Service Map</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <select x-model="timeWindow" @change="loadServiceMap()"
                                class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            <option value="15m">Last 15 minutes</option>
                            <option value="1h">Last hour</option>
                            <option value="6h">Last 6 hours</option>
                            <option value="24h">Last 24 hours</option>
                        </select>
                        <button @click="refresh()"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center space-x-2">
                            <svg class="w-4 h-4" :class="{ 'animate-spin': loading }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            <span>Refresh</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Stats Cards -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                    <div class="text-sm text-gray-500 dark:text-gray-400">Total Services</div>
                    <div class="text-2xl font-bold text-gray-900 dark:text-white" x-text="stats.totalNodes"></div>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                    <div class="text-sm text-gray-500 dark:text-gray-400">Connections</div>
                    <div class="text-2xl font-bold text-gray-900 dark:text-white" x-text="stats.totalConnections"></div>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                    <div class="text-sm text-gray-500 dark:text-gray-400">Healthy</div>
                    <div class="text-2xl font-bold text-green-600" x-text="stats.healthyNodes"></div>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                    <div class="text-sm text-gray-500 dark:text-gray-400">Issues</div>
                    <div class="text-2xl font-bold"
                         :class="(stats.degradedNodes + stats.unhealthyNodes) > 0 ? 'text-red-600' : 'text-gray-900 dark:text-white'"
                         x-text="stats.degradedNodes + stats.unhealthyNodes"></div>
                </div>
            </div>

            <!-- Service Map Visualization -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
                <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Dependency Graph</h2>
                </div>
                <div class="p-4">
                    <!-- Empty State -->
                    <template x-if="nodes.length === 0 && !loading">
                        <div class="text-center py-12">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"/>
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-white">No services detected</h3>
                            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                                Service dependencies are extracted from traces. Generate some traffic to see the map.
                            </p>
                        </div>
                    </template>

                    <!-- Loading State -->
                    <template x-if="loading">
                        <div class="text-center py-12">
                            <svg class="animate-spin mx-auto h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Loading service map...</p>
                        </div>
                    </template>

                    <!-- Service Map SVG -->
                    <template x-if="nodes.length > 0 && !loading">
                        <div class="relative overflow-auto" style="min-height: 500px;">
                            <svg :width="svgWidth" :height="svgHeight" class="mx-auto">
                                <!-- Connections -->
                                <template x-for="conn in connections" :key="conn.id">
                                    <g>
                                        <line :x1="getNodePosition(conn.sourceId).x + 60"
                                              :y1="getNodePosition(conn.sourceId).y + 30"
                                              :x2="getNodePosition(conn.targetId).x + 60"
                                              :y2="getNodePosition(conn.targetId).y + 30"
                                              :stroke="getConnectionColor(conn)"
                                              :stroke-width="getConnectionWidth(conn)"
                                              class="connection-line"
                                              stroke-dasharray="5,5"
                                              x-show="conn.type === 'DATABASE' || conn.type === 'QUEUE'"/>
                                        <line :x1="getNodePosition(conn.sourceId).x + 60"
                                              :y1="getNodePosition(conn.sourceId).y + 30"
                                              :x2="getNodePosition(conn.targetId).x + 60"
                                              :y2="getNodePosition(conn.targetId).y + 30"
                                              :stroke="getConnectionColor(conn)"
                                              :stroke-width="getConnectionWidth(conn)"
                                              class="connection-line"
                                              x-show="conn.type !== 'DATABASE' && conn.type !== 'QUEUE'"/>
                                    </g>
                                </template>

                                <!-- Nodes -->
                                <template x-for="(node, index) in nodes" :key="node.id">
                                    <g :transform="'translate(' + getNodePosition(node.id).x + ',' + getNodePosition(node.id).y + ')'"
                                       class="service-node cursor-pointer"
                                       @click="selectNode(node)">
                                        <!-- Node background -->
                                        <rect width="120" height="60" rx="8"
                                              :fill="getNodeColor(node)"
                                              :stroke="selectedNode?.id === node.id ? '#3B82F6' : 'transparent'"
                                              stroke-width="3"/>
                                        <!-- Health indicator -->
                                        <circle cx="108" cy="12" r="6" :fill="getHealthColor(node)"/>
                                        <!-- Node name -->
                                        <text x="60" y="35" text-anchor="middle" fill="white" font-size="12" font-weight="500"
                                              x-text="truncate(node.name, 14)"/>
                                        <!-- Node type icon -->
                                        <text x="12" y="18" fill="white" font-size="14" x-text="getNodeIcon(node)"/>
                                    </g>
                                </template>
                            </svg>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Node Details Panel -->
            <template x-if="selectedNode">
                <div class="mt-6 bg-white dark:bg-gray-800 rounded-lg shadow">
                    <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                        <h2 class="text-lg font-semibold text-gray-900 dark:text-white" x-text="selectedNode.name"></h2>
                        <button @click="selectedNode = null" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    <div class="p-4">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <div class="text-sm text-gray-500 dark:text-gray-400">Type</div>
                                <div class="font-medium text-gray-900 dark:text-white" x-text="selectedNode.type"></div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500 dark:text-gray-400">Health</div>
                                <div class="font-medium" :class="getHealthTextClass(selectedNode)" x-text="selectedNode.health"></div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500 dark:text-gray-400">Requests/s</div>
                                <div class="font-medium text-gray-900 dark:text-white" x-text="selectedNode.stats?.requestsPerSecond?.toFixed(2) || '0'"></div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500 dark:text-gray-400">Error Rate</div>
                                <div class="font-medium" :class="selectedNode.stats?.errorRate > 1 ? 'text-red-600' : 'text-gray-900 dark:text-white'"
                                     x-text="(selectedNode.stats?.errorRate?.toFixed(2) || '0') + '%'"></div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500 dark:text-gray-400">Avg Latency</div>
                                <div class="font-medium text-gray-900 dark:text-white" x-text="(selectedNode.stats?.avgLatencyMs?.toFixed(0) || '0') + 'ms'"></div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500 dark:text-gray-400">P99 Latency</div>
                                <div class="font-medium text-gray-900 dark:text-white" x-text="(selectedNode.stats?.p99LatencyMs?.toFixed(0) || '0') + 'ms'"></div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500 dark:text-gray-400">Total Requests</div>
                                <div class="font-medium text-gray-900 dark:text-white" x-text="selectedNode.stats?.totalRequests || '0'"></div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500 dark:text-gray-400">Total Errors</div>
                                <div class="font-medium text-gray-900 dark:text-white" x-text="selectedNode.stats?.totalErrors || '0'"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </template>

            <!-- Legend -->
            <div class="mt-6 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                <h3 class="text-sm font-medium text-gray-900 dark:text-white mb-3">Legend</h3>
                <div class="flex flex-wrap gap-6">
                    <div class="flex items-center space-x-2">
                        <div class="w-4 h-4 rounded bg-blue-500"></div>
                        <span class="text-sm text-gray-600 dark:text-gray-400">Service</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-4 h-4 rounded bg-green-500"></div>
                        <span class="text-sm text-gray-600 dark:text-gray-400">Database</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-4 h-4 rounded bg-amber-500"></div>
                        <span class="text-sm text-gray-600 dark:text-gray-400">Cache</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-4 h-4 rounded bg-purple-500"></div>
                        <span class="text-sm text-gray-600 dark:text-gray-400">Queue</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full bg-green-500"></div>
                        <span class="text-sm text-gray-600 dark:text-gray-400">Healthy</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full bg-amber-500"></div>
                        <span class="text-sm text-gray-600 dark:text-gray-400">Degraded</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full bg-red-500"></div>
                        <span class="text-sm text-gray-600 dark:text-gray-400">Unhealthy</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function serviceMapApp() {
            return {
                loading: false,
                timeWindow: '1h',
                nodes: [],
                connections: [],
                stats: {
                    totalNodes: 0,
                    totalConnections: 0,
                    healthyNodes: 0,
                    degradedNodes: 0,
                    unhealthyNodes: 0
                },
                selectedNode: null,
                nodePositions: {},
                svgWidth: 800,
                svgHeight: 500,

                init() {
                    this.loadServiceMap();
                },

                async loadServiceMap() {
                    this.loading = true;
                    try {
                        const response = await fetch(`/j-obs/api/service-map?window=${this.timeWindow}`);
                        const data = await response.json();
                        this.nodes = data.nodes || [];
                        this.connections = data.connections || [];
                        this.stats = data.stats || this.stats;
                        this.calculateLayout();
                    } catch (error) {
                        console.error('Error loading service map:', error);
                    } finally {
                        this.loading = false;
                    }
                },

                async refresh() {
                    this.loading = true;
                    try {
                        const response = await fetch('/j-obs/api/service-map/refresh', { method: 'POST' });
                        const data = await response.json();
                        this.nodes = data.nodes || [];
                        this.connections = data.connections || [];
                        this.stats = data.stats || this.stats;
                        this.calculateLayout();
                    } catch (error) {
                        console.error('Error refreshing service map:', error);
                    } finally {
                        this.loading = false;
                    }
                },

                calculateLayout() {
                    // Simple grid layout
                    const cols = Math.ceil(Math.sqrt(this.nodes.length));
                    const nodeWidth = 140;
                    const nodeHeight = 80;

                    this.nodes.forEach((node, index) => {
                        const row = Math.floor(index / cols);
                        const col = index % cols;
                        this.nodePositions[node.id] = {
                            x: 50 + col * nodeWidth,
                            y: 50 + row * nodeHeight
                        };
                    });

                    this.svgWidth = Math.max(800, 50 + cols * nodeWidth + 50);
                    this.svgHeight = Math.max(500, 50 + Math.ceil(this.nodes.length / cols) * nodeHeight + 50);
                },

                getNodePosition(nodeId) {
                    return this.nodePositions[nodeId] || { x: 0, y: 0 };
                },

                getNodeColor(node) {
                    const colors = {
                        'SERVICE': '#3B82F6',
                        'DATABASE': '#10B981',
                        'CACHE': '#F59E0B',
                        'QUEUE': '#8B5CF6',
                        'EXTERNAL': '#6B7280',
                        'CLIENT': '#EC4899'
                    };
                    return colors[node.type] || '#6B7280';
                },

                getHealthColor(node) {
                    const colors = {
                        'HEALTHY': '#10B981',
                        'DEGRADED': '#F59E0B',
                        'UNHEALTHY': '#EF4444',
                        'UNKNOWN': '#6B7280'
                    };
                    return colors[node.health] || '#6B7280';
                },

                getHealthTextClass(node) {
                    const classes = {
                        'HEALTHY': 'text-green-600',
                        'DEGRADED': 'text-amber-600',
                        'UNHEALTHY': 'text-red-600',
                        'UNKNOWN': 'text-gray-600'
                    };
                    return classes[node.health] || 'text-gray-600';
                },

                getNodeIcon(node) {
                    const icons = {
                        'SERVICE': '\u2699',
                        'DATABASE': '\u{1F4BE}',
                        'CACHE': '\u26A1',
                        'QUEUE': '\u{1F4E8}',
                        'EXTERNAL': '\u2601',
                        'CLIENT': '\u{1F464}'
                    };
                    return icons[node.type] || '\u2699';
                },

                getConnectionColor(conn) {
                    const health = this.calculateConnectionHealth(conn);
                    if (health === 'UNHEALTHY') return '#EF4444';
                    if (health === 'DEGRADED') return '#F59E0B';
                    return '#9CA3AF';
                },

                getConnectionWidth(conn) {
                    const maxRps = Math.max(...this.connections.map(c => c.stats?.requestsPerSecond || 0));
                    if (maxRps <= 0) return 2;
                    const ratio = (conn.stats?.requestsPerSecond || 0) / maxRps;
                    return Math.max(1, Math.min(6, Math.ceil(ratio * 6)));
                },

                calculateConnectionHealth(conn) {
                    if (!conn.stats) return 'UNKNOWN';
                    if (conn.stats.errorRate > 5) return 'UNHEALTHY';
                    if (conn.stats.errorRate > 1) return 'DEGRADED';
                    return 'HEALTHY';
                },

                selectNode(node) {
                    this.selectedNode = this.selectedNode?.id === node.id ? null : node;
                },

                truncate(text, maxLength) {
                    if (!text) return '';
                    return text.length > maxLength ? text.substring(0, maxLength - 2) + '..' : text;
                }
            };
        }
    </script>
</body>
</html>
